<div class="container mt-5 main-font">
    <div class="d-flex justify-content-between align-items-start mb-2">
        <h2 class="text-vibrante d-flex align-items-center m-0">
            <i class="bi bi-person-plus-fill me-2"></i> Cadastro do Alimentado
        </h2>
        
        <div class="text-end">
            <div class="text-vibrante text-uppercase mb-1" style="font-size: 1.1rem;">
                @if (etapaAtual === 1) { 1. IDENTIFICAÇÃO }
                @else if (etapaAtual === 2) { 2. LOCALIZAÇÃO }
                @else if (etapaAtual === 3) { 3. ESCOLAR }
                @else if (etapaAtual === 4) { 4. GENITOR(ES) / RESPONSÁVEL(EIS) }
            </div>
            <span class="badge bg-primary text-uppercase px-3 py-2">
                PASSO {{etapaAtual}} DE 4
            </span>
        </div>
    </div>
    <hr class="mb-5 opacity-25">

    <form>
        @if (etapaAtual === 1) {
            <div class="animate__animated animate__fadeIn">
                <div class="row g-4">
                    <div class="col-md-12">
                        <label>Nome Completo *</label>
                        <input type="text" class="form-control" [(ngModel)]="filho.nomeCompleto" name="nomeCompleto">
                    </div>
                    <div class="col-md-6">
                        <label>Nacionalidade</label>
                        <input type="text" class="form-control" [(ngModel)]="filho.nacionalidade" name="nacionalidade">
                    </div>
                    <div class="col-md-6">
                        <label class="label-forte">CPF *</label>
                        <div class="input-group">
                            <input type="text" 
                                class="form-control" 
                                [class.input-error]="cpfFilhoInvalido"
                                placeholder="000.000.000-00" 
                                [(ngModel)]="filho.cpf" 
                                (input)="validarCPFFilho()"
                                name="cpfFilho"
                                maxlength="14">
                        </div>
                        @if (cpfFilhoInvalido) {
                            <small class="text-error">CPF do alimentado inválido.</small>
                        }
                    </div>
                    <div class="col-md-6">
                        <label>Data de Nascimento</label>
                        <input type="date" class="form-control" [(ngModel)]="filho.dataNascimento" name="dataNascimento">
                    </div>
                </div>
            </div>
        }

        @if (etapaAtual === 2) {
            <div class="animate__animated animate__fadeIn">
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="form-check form-switch p-0 d-flex align-items-center gap-3">
                            <input class="form-check-input ms-0 custom-switch" type="checkbox" 
                                [(ngModel)]="moraComGenitor" name="moraComGenitor" id="checkMoraGenitor">
                            <label class="label-forte mb-0" for="checkMoraGenitor" style="text-transform: none;">
                                A criança mora com o genitor?
                            </label>
                        </div>
                    </div>
                </div>

                @if (moraComGenitor) {
                    <div class="row g-3 mb-4 animate__animated animate__fadeInDown">
                        <div class="col-md-4">
                            <label class="label-forte">CPF do Genitor *</label>
                            <div class="input-group">
                                <input type="text" 
                                    class="form-control" 
                                    [(ngModel)]="cpfGenitorBusca" 
                                    (input)="validarCPFDigitado()" 
                                    name="cpfGenitorBusca"
                                    maxlength="14" 
                                    placeholder="000.000.000-00">
                            </div>
                            @if (cpfInvalido) {
                                <small class="text-error">CPF inválido. Verifique os números.</small>
                            }
                        </div>
                        <div class="col-md-8">
                            <label class="label-forte">Nome do Genitor Encontrado</label>
                            <input type="text" class="form-control bg-light" [(ngModel)]="nomeGenitorEncontrado" name="nomeGenitorEncontrado" readonly>
                        </div>
                    </div>
                }

                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <label class="label-forte">CEP *</label>
                        <input type="text" 
                            class="form-control" 
                            [(ngModel)]="filho.cep" 
                            (input)="buscarCep()"
                            name="cep" 
                            maxlength="9"
                            placeholder="00000-000">
                    </div>

                    <div class="col-md-7">
                        <label class="label-forte">LOGRADOURO</label>
                        <input type="text" class="form-control" [(ngModel)]="filho.logradouro" name="logradouro">
                    </div>
                    <div class="col-md-2">
                        <label class="label-forte">Nº *</label>
                        <input type="text" class="form-control" [(ngModel)]="filho.numero" name="numero">
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="label-forte">COMPLEMENTO</label>
                        <input type="text" class="form-control" [(ngModel)]="filho.complemento" name="complemento">
                    </div>
                    <div class="col-md-4">
                        <label class="label-forte">BAIRRO</label>
                        <input type="text" class="form-control" [(ngModel)]="filho.bairro" name="bairro">
                    </div>
                    <div class="col-md-3">
                        <label class="label-forte">CIDADE</label>
                        <input type="text" class="form-control" [(ngModel)]="filho.cidade" name="cidade">
                    </div>
                    <div class="col-md-1">
                        <label class="label-forte">UF</label>
                        <input type="text" class="form-control" [(ngModel)]="filho.uf" name="uf" maxlength="2">
                    </div>
                </div>
            </div>
        }

        @if (etapaAtual === 3) {
            <div class="animate__animated animate__fadeIn">
                <div class="row g-4">
                    <div class="col-md-12">
                        <label class="label-forte">NOME DA INSTITUIÇÃO DE ENSINO</label>
                        <input type="text" class="form-control form-control-lg" [(ngModel)]="filho.escola" name="escola" placeholder="Ex: Escola Estadual Machado de Assis">
                    </div>
                    
                    <div class="col-md-6">
                        <label class="label-forte">SÉRIE / ANO</label>
                        <select class="form-select form-select-lg" [(ngModel)]="filho.serie" name="serie">
                            <option value="" disabled selected>Selecione a série...</option>
                            <optgroup label="Educação Infantil">
                                <option value="Berçário">Berçário</option>
                                <option value="Maternal / Creche">Maternal / Creche</option>
                                <option value="Pré-Escola">Pré-Escola</option>
                            </optgroup>
                            <optgroup label="Ensino Fundamental I">
                                <option value="1º Ano">1º Ano</option>
                                <option value="2º Ano">2º Ano</option>
                                <option value="3º Ano">3º Ano</option>
                                <option value="4º Ano">4º Ano</option>
                                <option value="5º Ano">5º Ano</option>
                            </optgroup>
                            <optgroup label="Ensino Fundamental II">
                                <option value="6º Ano">6º Ano</option>
                                <option value="7º Ano">7º Ano</option>
                                <option value="8º Ano">8º Ano</option>
                                <option value="9º Ano">9º Ano</option>
                            </optgroup>
                            <optgroup label="Ensino Médio">
                                <option value="1º Ano Médio">1º Ano Médio</option>
                                <option value="2º Ano Médio">2º Ano Médio</option>
                                <option value="3º Ano Médio">3º Ano Médio</option>
                            </optgroup>
                            <option value="Outros">Outros / Ensino Superior</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="label-forte">TURNO</label>
                        <select class="form-select form-select-lg" [(ngModel)]="filho.turno" name="turno">
                            <option value="" disabled selected>Escolha o turno...</option>
                            <option value="Matutino">Matutino</option>
                            <option value="Vespertino">Vespertino</option>
                            <option value="Noturno">Noturno</option>
                            <option value="Integral">Integral</option>
                        </select>
                    </div>

                    <div class="col-md-12 mt-5">
                        <h5 class="text-vibrante d-flex align-items-center mb-0">
                            <i class="bi bi-calendar3 me-2"></i> PERÍODOS E FÉRIAS
                        </h5>
                        <hr class="mt-2 mb-4 opacity-25">
                    </div>

                    <div class="col-md-6">
                        <label class="label-forte text-primary">INÍCIO DO PERÍODO LETIVO</label>
                        <input type="date" class="form-control form-control-lg border-primary-subtle" [(ngModel)]="filho.dataInicioPeriodoLetivo" name="dataInicioPeriodoLetivo">
                    </div>
                    <div class="col-md-6">
                        <label class="label-forte text-primary">TÉRMINO DO PERÍODO LETIVO</label>
                        <input type="date" class="form-control form-control-lg border-primary-subtle" [(ngModel)]="filho.dataTerminoPeriodoLetivo" name="dataTerminoPeriodoLetivo">
                    </div>

                    <div class="col-md-6">
                        <label class="label-forte text-info">INÍCIO DO RECESSO</label>
                        <input type="date" class="form-control form-control-lg border-info-subtle" [(ngModel)]="filho.dataInicioRecessoEscolar" name="dataInicioRecessoEscolar">
                    </div>
                    <div class="col-md-6">
                        <label class="label-forte text-info">TÉRMINO DO RECESSO</label>
                        <input type="date" class="form-control form-control-lg border-info-subtle" [(ngModel)]="filho.dataTerminoRecessoEscolar" name="dataTerminoRecessoEscolar">
                    </div>

                    <div class="col-md-6">
                        <label class="label-forte text-success">INÍCIO DAS FÉRIAS</label>
                        <input type="date" class="form-control form-control-lg border-success-subtle" [(ngModel)]="filho.dataInicioFeriasEscolar" name="dataInicioFeriasEscolar">
                    </div>
                    <div class="col-md-6">
                        <label class="label-forte text-success">TÉRMINO DAS FÉRIAS</label>
                        <input type="date" class="form-control form-control-lg border-success-subtle" [(ngModel)]="filho.dataTerminoFeriasEscolar" name="dataTerminoFeriasEscolar">
                    </div>
                </div>
            </div>
        }

        @if (etapaAtual === 4) {
            <div class="animate__animated animate__fadeIn">
                <div class="row g-3 mb-4 align-items-end">
                    <div class="col-md-3">
                        <label class="label-forte text-uppercase small">CPF do Responsável</label>
                        <input type="text" class="form-control form-control-lg" 
                            [(ngModel)]="cpfBuscaResponsavel" 
                            (input)="validarCPFResponsavel()"
                            name="cpfBuscaRes" 
                            placeholder="000.000.000-00" 
                            maxlength="14">
                    </div>

                    <div class="col-md-5">
                        <label class="label-forte text-uppercase small">Nome do Responsável</label>
                        <input type="text" class="form-control form-control-lg bg-light" 
                            [(ngModel)]="nomeResponsavelEncontrado" 
                            name="nomeResEncontrado" readonly>
                    </div>
                    
                    <div class="col-md-2">
                        <label class="label-forte text-uppercase small">Valor Pensão (R$)</label>
                        <input type="number" class="form-control form-control-lg" 
                            [(ngModel)]="valorPensaoTemp" 
                            name="valorPensaoT" 
                            placeholder="0.00">
                    </div>

                    <div class="col-md-2">
                        <button type="button" class="btn btn-primary btn-lg w-100 shadow-sm" 
                                (click)="adicionarResponsavelGrid()"
                                [disabled]="!nomeResponsavelEncontrado">
                            <i class="bi bi-plus-lg"></i> ADD
                        </button>
                    </div>
                </div>

                <div class="table-responsive border rounded-3 shadow-sm bg-white">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-primary text-white text-uppercase small">
                            <tr>
                                <th class="p-3">CPF</th>
                                <th class="p-3">GESTOR / RESPONSÁVEL</th>
                                <th class="p-3 text-center">FUNÇÃO FAMILIAR</th>
                                <th class="p-3">VALOR PENSÃO</th>
                                <th class="p-3 text-center">AÇÕES</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (item of responsaveisGrid; track item.id; let i = $index) {
                                <tr>
                                    <td class="p-3 text-muted">{{item.cpf}}</td>
                                    <td class="p-3 fw-bold text-dark">{{item.nomeCompleto}}</td>
                                    <td class="p-3 text-center">
                                        <span class="badge rounded-pill bg-light text-dark border px-3">
                                            {{ 
                                                item.tipo === 1 ? 'GUARDIÃO' : 
                                                item.tipo === 2 ? 'ALIMENTANTE' : 
                                                item.tipo === 3 ? 'RESP. LEGAL' : 'N/D' 
                                            }}
                                        </span>
                                    </td>
                                    <td class="p-3 fw-bold text-primary">
                                        R$ {{item.valorPensao | number:'1.2-2'}}
                                    </td>
                                    <td class="p-3 text-center">
                                        <button type="button" class="btn btn-link text-danger p-0" 
                                                (click)="removerResponsavel(i)">
                                            <i class="bi bi-trash3 fs-5"></i>
                                        </button>
                                    </td>
                                </tr>
                            } @empty {
                                <tr>
                                    <td colspan="5" class="text-center p-5 text-muted italic">
                                        <i class="bi bi-info-circle me-2"></i>
                                        Nenhum responsável vinculado até o momento.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }

        <div class="mt-5 pt-4 d-flex justify-content-center gap-3 border-top">
            <button type="button" class="btn btn-outline-secondary btn-lg custom-btn-nav" 
                    (click)="voltar()" [disabled]="etapaAtual === 1">
                ANTERIOR
            </button>

            @if (etapaAtual < 4) {
                <button type="button" class="btn btn-primary btn-lg custom-btn-nav shadow-sm" (click)="proximo()">
                    PRÓXIMO PASSO <i class="bi bi-arrow-right ms-2"></i>
                </button>
            } @else {
                <button type="button" class="btn btn-success btn-lg custom-btn-nav shadow-sm" (click)="salvar()">
                    SALVAR CADASTRO <i class="bi bi-check-lg ms-2"></i>
                </button>
            }
        </div>
        
        <div class="text-center mt-4">
            <small class="text-danger">* Preencha Nome, Nacionalidade, CPF válido e Data de Nascimento.</small>
        </div>
    </form>
</div>